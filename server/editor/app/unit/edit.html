<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <title>Editor - Edit Unit</title>
  </head>
  <body class="h-screen bg-gray-800 text-white">
    <code id="form-submited" class="hidden"></code>
    <code
      hx-on::after-request="loadForm(event)"
      hx-get="/api/unit"
      hx-trigger="load"
      id="unit-data"
      class="hidden"
    ></code>
    <div class="flex flex-col items-center p-4">
      <form
        id="unit"
        hx-put="/api/unit"
        hx-target="#form-submited"
        hx-trigger="submit"
        hx-on::after-request="onSubmited(event)"
      ></form>
      <input form="unit" name="id" id="id" class="hidden" />
      <div class="container">
        <h1 class="text-6xl font-bold text-center">Create Unit</h1>

        <h5 class="font-semibold text-2xl mb-4 border-b-2">General</h5>
        <section class="flex flex-col">
          <div class="mb-2 flex flex-col">
            <label for="name" class="mb-2 font-bold tracking-tighter"
              >Name</label
            >
            <input
              form="unit"
              class="text-black"
              required
              id="name"
              name="name"
              type="text"
            />
          </div>

          <section @set-icon.window="icon=$event.detail" x-data="{ icon: '' }">
            <div>
              <img alt="unit-icon" :src="icon" class="h-28 2-28" />
            </div>
            <div class="mb-2 flex flex-col">
              <label
                class="mb-2 font-bold tracking-tighter"
                for="icon"
                class="mb-2"
                >Icon</label
              >
              <input
                x-model="icon"
                form="unit"
                class="text-black"
                required
                id="icon"
                name="icon"
                type="url"
              />
            </div>
          </section>

          <div class="mb-2 flex flex-col">
            <label for="description" class="mb-2 font-bold tracking-tighter"
              >Description</label
            >
            <textarea
              form="unit"
              class="text-black"
              name="description"
              id="description"
              cols="40"
              rows="5"
            ></textarea>
          </div>
        </section>

        <h5 class="font-semibold text-2xl mb-4 border-b-2">Build settings</h5>
        <section class="flex flex-col">
          <div class="mb-2 flex flex-col">
            <label for="cost" class="mb-2 font-bold tracking-tighter"
              >Cost</label
            >
            <input
              form="unit"
              class="text-black"
              required
              id="cost"
              name="cost"
              type="number"
              value="10"
            />
          </div>

          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="time"
              >Time</label
            >
            <input
              form="unit"
              class="text-black"
              required
              type="number"
              id="time"
              value="1"
              name="time"
              min="1"
            />
          </div>

          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="capSize"
              >Cap Size</label
            >
            <input
              form="unit"
              required
              class="text-black"
              type="number"
              id="capSize"
              name="capSize"
              value="1"
              min="0"
            />
          </div>

          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="globalMax"
              >Global Max Units</label
            >
            <input
              form="unit"
              required
              class="text-black"
              type="number"
              id="globalMax"
              name="globalMax"
              min="-1"
              value="-1"
            />
          </div>
        </section>

        <!--Requires-->
        <section
          @set-requires.window="requires=$event.detail"
          class="mb-2"
          x-data="{ requires: [] }"
        >
          <form
            @submit.prevent="addRequired($data,event)"
            id="requirements"
            class="hidden"
          ></form>
          <input
            :value="JSON.stringify(requires)"
            class="hidden"
            id="requires"
            name="requires"
            form="unit"
          />
          <h6 class="font-semibold text-xl mb-4 border-b-2">Requires</h6>

          <div class="flex items-center gap-4 mb-2">
            <label class="flex flex-col">
              <span class="mb-2">Type</span>
              <select
                name="requires.type"
                form="requirements"
                class="text-black p-1"
                required
                data-id="requires.type"
              >
                <option value="global">Global</option>
                <option value="local" selected>Local</option>
              </select>
            </label>

            <label class="flex flex-col">
              <span class="mb-2">Item</span>
              <select
                required
                hx-get="/api/building/list"
                hx-trigger="load"
                name="requires.id"
                form="requirements"
                class="text-black p-1"
                data-id="requires.id"
              >
                <option disabled>Loading</option>
              </select>
            </label>

            <button
              form="requirements"
              class="px-2 py-1 bg-blue-700 hover:bg-blue-600 rounded-md mt-6"
              type="submit"
            >
              Add Requirement
            </button>
          </div>

          <table class="ml-4 divide-y">
            <thead>
              <tr class="divide-x">
                <th class="p-2">Item Id</th>
                <th class="p-2">Requirement Type</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(requirement,i) in requires">
                <tr>
                  <td class="p-2">
                    <a
                      x-text="requirement.id"
                      class="text-blue-400 hover:text-blue-300 underline"
                      :href="`/building?search=${requirement.id}&search-type=id`"
                      data-id="content-id"
                    ></a>
                  </td>
                  <td class="p-2" x-text="requirement.type"></td>
                  <td class="p-2">
                    <button
                      @click="requires.splice(i,1)"
                      class="px-1.5 py-0.5 bg-red-700 hover:bg-red-600 rounded-md"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </section>

        <h5 class="font-semibold text-2xl mb-4 border-b-2">Battle Stats</h5>

        <!--General Battle Stats-->
        <section class="flex flex-col">
          <div class="mb-2">
            <input
              form="unit"
              type="checkbox"
              name="stats.isScout"
              id="stats.isScout"
            />
            <label class="mb-2 font-bold tracking-tighter" for="stats.isScout"
              >isScout</label
            >
          </div>
          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="stats.attack"
              >Unit Attack</label
            >
            <input
              form="unit"
              class="text-black"
              required
              type="number"
              name="stats.attack"
              id="stats.attack"
              value="0"
              min="0"
            />
          </div>
          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="stats.health"
              >Unit Health</label
            >
            <input
              form="unit"
              class="text-black"
              required
              type="number"
              name="stats.health"
              id="stats.health"
              value="100"
              min="0"
            />
          </div>
          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="stats.shealds"
              >Unit Shealds</label
            >
            <input
              form="unit"
              class="text-black"
              required
              type="number"
              name="stats.shealds"
              id="stats.shealds"
              value="0"
              min="0"
            />
          </div>
          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="stats.hitChange"
              >Unit Hit Chance</label
            >
            <input
              form="unit"
              class="text-black"
              required
              type="number"
              name="stats.hitChange"
              id="stats.hitChange"
              min="0"
              value="50"
              max="100"
            />
          </div>
        </section>

        <!-- Effecitve Config -->
        <section>
          <h6 class="font-semibold text-xl mb-4 border-b-2">Effective</h6>
          <div class="ml-4 flex flex-col mb-2">
            <label
              class="mb-2 font-bold tracking-tighter"
              for="stats.effective.air"
              >Air</label
            >
            <select
              form="unit"
              class="text-black p-1"
              id="stats.effective.air"
              name="stats.effective.air"
              required
            >
              <option value="weak">Weak</option>
              <option value="normal" selected>Normal</option>
              <option value="strong">Strong</option>
            </select>
          </div>
          <div class="ml-4 flex flex-col mb-2">
            <label
              class="mb-2 font-bold tracking-tighter"
              for="stats.effective.infantry"
              >Infantry</label
            >
            <select
              form="unit"
              class="text-black p-1"
              id="stats.effective.infantry"
              name="stats.effective.infantry"
              required
            >
              <option value="weak">Weak</option>
              <option value="normal" selected>Normal</option>
              <option value="strong">Strong</option>
            </select>
          </div>
          <div class="ml-4 flex flex-col mb-2">
            <label
              class="mb-2 font-bold tracking-tighter"
              for="stats.effective.vehicle"
              >Vehicle</label
            >
            <select
              form="unit"
              class="text-black p-1"
              id="stats.effective.vehicle"
              required
              name="stats.effective.vehicle"
            >
              <option value="weak">Weak</option>
              <option selected value="normal">Normal</option>
              <option value="strong">Strong</option>
            </select>
          </div>
          <div class="ml-4 flex flex-col mb-2">
            <label
              class="mb-2 font-bold tracking-tighter"
              for="stats.effective.building"
              >Building</label
            >
            <select
              form="unit"
              class="text-black p-1"
              id="stats.effective.building"
              required
              name="stats.effective.building"
            >
              <option value="weak">Weak</option>
              <option selected value="normal">Normal</option>
              <option value="strong">Strong</option>
            </select>
          </div>
        </section>

        <!-- Battle Type & Damage Type -->
        <section class="flex flex-col">
          <div class="mb-2 flex flex-col">
            <label class="mb-2 font-bold tracking-tighter" for="stats.type"
              >Unit Type</label
            >
            <select
              form="unit"
              class="text-black p-1"
              id="stats.type"
              required
              name="stats.type"
              value="infantry"
            >
              <option value="infantry" selected>Infantry</option>
              <option value="air">Air</option>
              <option value="vehicle">Vehicle</option>
              <option value="Building">Building</option>
            </select>
          </div>
          <div class="mb-2 flex flex-col">
            <label
              class="mb-2 font-bold tracking-tighter"
              for="stats.damageType"
              >Damage Type</label
            >
            <select
              form="unit"
              class="text-black p-1"
              id="stats.damageType"
              required
              name="stats.damageType"
              value="kinetic"
            >
              <option value="kinetic" selected>Kinetic</option>
              <option value="plasma">Plasma</option>
              <option value="hardlight">Hardlight</option>
              <option value="burn">Burn</option>
              <option value="freeze">Freeze</option>
            </select>
          </div>
        </section>

        <section
          @set-events.window="events=$event.detail"
          x-data="{ events: [] }"
          class="ml-4"
        >
          <form id="events" @submit.prevent="addEvent($data,event)"></form>
          <input
            class="hidden"
            id="events-data"
            name="stats.events"
            form="unit"
            :value="JSON.stringify(events)"
          />
          <h6 class="font-semibold text-xl mb-4 border-b-2">Unit Events</h6>

          <div class="flex gap-4">
            <div class="mb-2 flex flex-col">
              <label class="mb-2 font-bold tracking-tighter" for="trigger"
                >Event Trigger</label
              >
              <select
                required
                form="events"
                name="event-trigger"
                class="text-black p-1"
              >
                <option value="onDeath">onDeath</option>
                <option value="onHit">onHit</option>
              </select>
            </div>

            <div class="mb-2 flex flex-col">
              <label class="mb-2 font-bold tracking-tighter" for=""
                >Event Type</label
              >
              <select
                required
                form="events"
                name="event-type"
                hx-get="/api/unit/event"
                value="spawn"
                hx-target="#unit-event-params"
                class="text-black p-1"
              >
                <option value="spawn">Spawn</option>
                <option value="exploded">Exploded</option>
                <option value="servive">Servive</option>
                <option value="siphon">Siphon</option>
                <option value="burn">Burn</option>
                <option value="freeze">Freeze</option>
              </select>
            </div>
          </div>

          <div id="unit-event-params">
            <div class="mb-2 flex flex-col">
              <label class="mb-2 font-bold tracking-tighter">Amount</label>
              <input
                class="text-black"
                form="events"
                type="number"
                name="amount"
                required
                min="1"
                value="1"
              />
            </div>
            <div class="mb-2 flex flex-col">
              <label class="mb-2 font-bold tracking-tighter">Unit</label>
              <select
                hx-get="/api/unit/list"
                hx-trigger="load"
                required
                name="unit"
                form="events"
                class="text-black p-1"
              >
                <option disabled>Loading</option>
              </select>
            </div>
          </div>

          <button
            form="events"
            type="submit"
            class="px-2.5 py-2 bg-blue-700 hover:bg-blue-600 rounded-md"
          >
            Add
          </button>

          <table class="divide-y">
            <thead>
              <tr class="divide-x">
                <th class="p-1">Trigger</th>
                <th class="p-1">Event</th>
                <th class="p-1">Params</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(event,i) in events">
                <tr class="divide-x">
                  <td class="p-1" x-text="event.trigger"></td>
                  <td class="p-1" x-text="event.name"></td>
                  <td class="p-1">
                    <table>
                      <thead>
                        <tr class="divide-x">
                          <template x-for="param in Object.keys(event.params)">
                            <th x-text="param"></th>
                          </template>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="divide-x">
                          <template
                            x-for="value in Object.values(event.params)"
                          >
                            <td x-text="value"></td>
                          </template>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                  <td class="p-1">
                    <button
                      @click="events.splice(i,1)"
                      class="px-1.5 py-1 bg-red-700 hover:bg-red-600 rounded-md"
                      type="button"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </section>

        <div class="flex justify-end">
          <button
            form="unit"
            class="px-2.5 py-2 bg-green-700 hover:bg-green-600 rounded-md"
            type="submit"
          >
            Update
          </button>
        </div>
      </div>
    </div>
    <script>
      document.body.addEventListener("htmx:configRequest", function (evt) {
        if (evt.detail.path === "/api/unit") {
          const search = new URLSearchParams(window.location.search);
          evt.detail.parameters["id"] = search.get("id");
        }
      });

      function onSubmited(event) {
        if (event.detail.successful) {
          window.location.href = "/unit";
          return;
        }

        /** @type {XMLHttpRequest}*/
        const response = event.detail.xhr;
        alert(response.responseText);
      }

      function setFormInputValue(target, value) {
        /** @type {HTMLInputElement} */
        const el = document.getElementById(target);
        if (!el) throw new Error(`Failed to get element ${target}`);

        if (el.getAttribute("type") === "checkbox") {
          el.checked = value;
          return;
        }

        el.value = value;
      }

      function loadForm(event) {
        const unit = JSON.parse(event.target.innerText);

        const ignore = ["type", "requires"];

        for (const [key, value] of Object.entries(unit)) {
          if (ignore.includes(key)) continue;
          if (typeof value === "object") {
            // stats
            for (const [statKey, statValue] of Object.entries(value)) {
              if (statKey === "events") continue;
              if (statKey === "effective") {
                for (const [effectiveKey, effectiveValue] of Object.entries(
                  statValue
                )) {
                  console.log(
                    "SET",
                    `${key}.${statKey}.${effectiveKey}`,
                    effectiveValue
                  );
                  setFormInputValue(
                    `${key}.${statKey}.${effectiveKey}`,
                    effectiveValue
                  );
                }
                continue;
              }
              console.log("SET", `${key}.${statKey}`, statValue);
              setFormInputValue(`${key}.${statKey}`, statValue);
            }
            continue;
          }
          console.log("SET", key, value);
          setFormInputValue(key, value);
        }

        window.dispatchEvent(
          new CustomEvent("set-item", { detail: unit.icon })
        );
        window.dispatchEvent(
          new CustomEvent("set-requires", { detail: unit.requires })
        );

        if (unit.stats.events) {
          window.dispatchEvent(
            new CustomEvent("set-events", {
              detail: [
                ...units.stats.events?.onHit?.map(({ type, ...rest }) => ({
                  trigger: "onHit",
                  name: type,
                  params: { ...rest },
                })),
                ...units.stats.events?.onDeath?.map(({ type, ...rest }) => ({
                  trigger: "onDeath",
                  name: type,
                  params: { ...rest },
                })),
              ],
            })
          );
        }
      }

      function addRequired(data, event) {
        const params = new FormData(event.target);
        const id = params.get("requires.id");
        const type = params.get("requires.type");
        if (!id || !type) return;
        data.requires.push({ type, id: parseInt(id) });
      }
      function addEvent(data, event) {
        const ctx = new FormData(event.target);

        const eventTrigger = ctx.get("event-trigger");
        const eventType = ctx.get("event-type");

        const params = Array.from(ctx.keys())
          .filter((value) => !["event-trigger", "event-type"].includes(value))
          .reduce((pre, curr) => {
            const item = ctx.get(curr);
            if (!item) return pre;
            pre[curr] = item;
            return pre;
          }, {});

        data.events.push({ name: eventType, trigger: eventTrigger, params });
      }
    </script>
  </body>
</html>
